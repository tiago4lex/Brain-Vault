2025-07-08 09:56

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[Ferramentas]] | [[CanSniffer]]

----
# Introdução

O **CanSniffer** é uma ferramenta da análise de tráfego de rede CAN *(Controller Area Network)*, amplamente utilizada em sistemas embarcados, especialmente na indústria automotiva. Ela permite monitorar, filtrar e analisar mensagens CAN em tempo real, sendo útil para engenheiros de software, pesquisadores de segurança e técnicos automotivos.

![[Pasted image 20250708095859.png]]

---
# O que é o CanSniffer?

O CanSniffer é um software ou script (geralmente escrito em C, Python ou outras linguagens) que captura pacotes transmitidos em uma rede CAN, exibindo-os de forma legível. Ele pode ser usado para:

- Monitorar comunicações entre ECUs *(Eletronic Control Units)* em veículos.
- Identificar mensagens específicas por ID, dados ou intervalo de tempo.
- Diagnosticar falhas ou comportamentos anômalos em sistemas embarcados.
- Realizar engenharia reversa de protocolos CAN.

---
# Para que serve o CanSniffer?

O CanSniffer é usado principalmente para:

- **Diagnóstico Automotivo:** Identificar mensagens CAN relacionados e sensores, atuadores e outros componentes.
- **Segurança Cibernética:** Detectar comunicações suspeitas ou ataques em redes CAN (ex.: injeção de frames maliciosos).
- **Engenharia Reversa:** Decifrar protocolos proprietários usados por fabricantes de veículos.
- **Desenvolvimento de Firmware:** Validar a comunicação entre módulos eletrônicos.

---
# O que é uma Rede CAN?

A ***Controller Area Network* (CAN)** é um protocolo de comunicação serial amplamente utilizada em sistemas embarcados, especialmente na indústria automotiva. Foi desenvolvida pela Bosch na década de 1980 para permitir que diferentes módulos eletrônicos **(ECUs - *Eletronic Control Units*)** se comuniquem de forma eficiente e confiável.

## Características Principais

- **Topologia em Barramento:** Todos os dispositivos compartilham o mesmo barramento CAN (dois fios: CAN_H e CAN_L).
- **Comunicação Multicast:** Uma mensagem enviada pode ser lida por vários nós.
- **Priorização de Mensagens:** O **ID da mensagem** define sua prioridade (quanto menor o ID, maior a prioridade).
- **Resistência a Ruídos:** Usa **diferencial de tensão** para reduzir interferências.
- **Taxas de Transmissão Comuns:**
	- **CAN Clássico (CAN 2.0A/B):** até 1 Mbps (em curtas distâncias).
	- **CAN FD *(Flexible Data-Rate)*:** Permite taxas mais altas e payloads maiores.

---
# Estrutura de uma Mensagem CAN

Uma mensagem CAN **(CAN Frame)** é composta por:

| **Campo**                | **Tamanho (bits)**             | **Descrição**                                          |
| ------------------------ | ------------------------------ | ------------------------------------------------------ |
| Identificador (ID)       | 11 (CAN 2.0A) ou 29 (CAN 2.0B) | Define a prioridade e o tipo de mensagem.              |
| DLC *(Data Length Code)* | 4                              | Indica o tamanho dos dados (0 a 8 bytes).              |
| Dados (Payload)          | 0 a 64 (CAN FD)                | Conteúdo da mensagem (ex.: RPM, velocidade, comandos). |
| CRC *(Checksum)*         | 15                             | Verificação de integridade de dados.                   |
| ACK *(Acknowledge)*      | 1                              | Confirmação de recebimento.                            |

---
# Significado dos IDs CAN

O **ID da mensagem** (11 ou 29 bits) determina:

- **Prioridade:** Quanto menor o ID, maior a prioridade (ex.: `0x000` tem prioridade máxima)
- **Tipo de Mensagem:** Em veículos, cada ID está associado a um módulo ou função.

## Exemplos de IDs Comuns em Veículos:

| **ID (Hex)** | **Descrição**                                                |
| ------------ | ------------------------------------------------------------ |
| `0x7DF`      | Requisição genérica OBD-II (ex.: leitura de RPM, velocidade) |
| `0x7E0`      | Mensagem de diagnóstico (ECU de injeção).                    |
| `0x7E8`      | Resposta da ECU para diagnóstico.                            |
| `0x100`      | Dados do motor (RPM, temperatura).                           |
| `0x200`      | Sistema de freios (ABS, ESP).                                |
| `0x300`      | Sistema de transmissão (câmbio automático).                  |
| `0x400`      | Sistema de conforto (vidros, travas).                        |

> [!note] Observação:
> Os IDs variam conforme o fabricante (ex.: Volkswagen, Toyota, Ford têm mapeamentos diferentes).

---
# Significado dos Dados (Payload)

O **payload** (0 a 8 bytes no CAN Clássico) contém a informação real transmitida. A interpretação depende do **ID** e do **protocolo usado**.

## Exemplo de Decodificação:

### Exemplo 1: Leitura de RPM (ID 0x7DF):

- **Requisição OBD-II (PID 0x0C = RPM)**

```text
ID: 0x7DF | Data: 02 01 0C 00 00 00 00 00
```

- `02` = Número de bytes adicionais.
- `01` = Modo de diagnóstico (leitura de dados).
- `0C` = PID (Parameter ID) para RPM

- **Resposta da ECU (ID 0x7E8):**

```text
ID: 0x7E8 | Data: 04 41 0C 1A F8 00 00 00
```

- `04` = Número de bytes de dados.
- `41` = Modos de repostas (`01` + `40`).
- `0C` = PID solicitado (RPM).
- `1A F8` = Valor do RPM (em hexadecimal)
	- Fórmula: `RPM = (A * 256 + B) / 4` → `(0x1A * 256 + 0xF8) / 4 = 1720 RPM`.

### Exemplo 2: Velocidade do Veículo (ID 0x0AA)

- Supondo que `0x0AA` seja a mensagem de velocidade:

```text
ID: 0x0AA | Data: 00 00 00 45 00 00 00 00
```

- `45` (em hexadecimal) = `69` em decimal → **69 km/h**

### Exemplo 3: Estado dos Freios (ID 0x1D0)

- Supondo que `0x1D0` seja a mensagem do sistema de freios:

```text
ID: 0x1D0 | Data: 01 00 00 00 00 00 00 00
```

- `01` no primeiro byte pode significar **freio pressionado**.

---
# Tipos de Frames CAN

| **Tipo de Frame** | **Descrição**                                                    |
| ----------------- | ---------------------------------------------------------------- |
| *Data Frame*      | Transporta dados (ex.: RPM, velocidade).                         |
| *Remote Frame*    | Solicita dados de outro nó (raro em sistemas modernos).          |
| *Error Frame*     | Indica um erro na rede (ex.: colisão, falha de CRC).             |
| *Overload Frame*  | Usado para atrasar a transmissão (em casos de congestionamento). |

---
# Técnicas de Engenharia Reversa em CAN

Para decifrar IDs e dados desconhecidos:

1. **Gravação Passiva:** Usar `candump` ou `CanSniffer` para capturar tráfego normal.
2. **Testes Ativos:** Enviar mensagens e observar respostas (ex.: usando `cansend`).
3. **Análise de Padrões:** Comparar dados em diferentes estados (ex.: acelerando vs. freando).
4. **Documentação de Fabricantes:** Algumas ECUs seguem padrões como **SAE J1939** (caminhões) ou **ISO-TP** (diagnóstico).

---
# Como o CanSniffer é usado?

## 1. Requisitos Básicos

- **Hardware:**
	- Interface CAN (ex.: USB-CAN adapters como Kvaser, Peak CAN, ou SocketCAN no Linux).
	- Conexão física à rede CAN (via OBD-II em veículos).

![[Pasted image 20250708100436.png]]

- **Software:**
	- Ferramentas como `candumb` (Linux), `Kayak`, ou bibliotecas como `python-can`.

## 2. Funcionamento Básico

1. **Captura Pacotes:**
	- O CanSniffer escuta a rede CAN e exibe as mensagens em formato hexadecimal ou decodificado.
	- Exemplo de saída:

```text
ID: 0x7DF | Data: 02 01 0D 00 00 00 00 00
ID: 0x7E8 | Data: 03 41 0D 2F 00 00 00 00
```

2. **Filtragem:**
	- Permite filtrar mensagens por ID, intervalo de bytes ou outros critérios.
	- Exemplo de filtro or ID `0x7DF`

```bash
cansniffer -i vcan0 -f "0x7DF"
```

3. **Análise:**
	- Interpretação dos dados (ex.: RPM do motor, velocidade, estado dos freios).

---
# Diferentes usos do CanSniffer

## Diagnóstico de Falhas

- Identificar mensagens de erro (ex.: `ID 0x7E0` para diagnóstico OBD-II).
- Verificar se um sensor está enviando dados corretamente.

## Engenharia Reversa

- Mapear IDs CAN para funções específicas (ex.: `0x2A1` = Velocidade do veículo).
- Exemplo de decodificação:

```python
def decode_speed(data):
	return (data[1] << 8) + data[2]   # Cálculo de velocidade em km/h
```

## Segurança Automotiva

- Detectar ataques como **DoS CAN** (envio massivo de frames) ou **Spoofing** (falsificação de mensagens).
- Exemplo de frame malicioso:

```bash
cansend vcan0 0x123#DEADBEEF
```

## Desenvolvimento de Firmware

- Validar se uma ECU está enviando/recebendo mensagens corretamente.
- Simular mensagens para testes (ex.: ativar faróis via CAN).

---
# Exemplos Práticos

## 1. Monitoramento Básico

```bash
# Usando candump (Linux SocketCAN)
candump vcan0

# Saída:
#  vcan0  0x7DF   [8]  02 01 0D 00 00 00 00 00
#  vcan0  0x7E8   [8]  03 41 0D 2F 00 00 00 00
```

## 2. Filtragem por ID

```bash
# Filtrar apenas mensagens com ID 0x7DF
cansniffer -i vcan0 -f "0x7DF"
```

## 3. Script Python com python-can

```python
import can

bus = can.interface.Bus(channel='vcan0', bustype='socketcan')
for msg in bus:
	print(f"ID: {hex(msg.arbitration_id)} | Data: {msg.data.hex()}")
```

## 4. Simulação de Ataque (Spoofing)

```bash
# Enviar um frame CAN falso (ID 0x123, dado 0xDEADBEEF)
cansend vcan0 0x123#DEADBEEF
```

---
## Exemplo 1: Ligar/Desligar Faróis via CAN

Em muitos carros, os faróis são controlador por uma **ECU de iluminação, que responde a mensagens CAN específicas.**

### Passo 1: Identificar o ID e Dados do Farol

1. **Monitore o tráfego CAN** enquanto liga/desliga os faróis:

```bash
candump can0
```

**Saída quando o farol é ligado:**

```text
can0  0x301   [8]  01 00 00 00 00 00 00 00
```

**Saída quando o farol é desligado:**

```text
can0  0x301   [8]  00 00 00 00 00 00 00 00
```

- Neste exemplo, o **ID** `0x301` controla os faróis, e o **primeiro byte (`01`)** liga o farol.

### Passo 2: Enviar o Comando para Ligar Farol

```bash
cansend can0 0x301#0100000000000000
```

- `0x301` = ID do farol.
- `01` = Liga o farol (outros bytes são zeros por padrão).

### Passo 3: Enviar comando para Desligar Farol

```bash
cansend can0 0x301#0000000000000000
```

- `00` no primeiro byte desliga o farol

---
## Exemplo 2: Controlar Luzes do Painel

Algumas luzes do painel (como **seta, óleo, bateria**) também são controladas por CAN.

### Passo 1: Identificar o ID e Dados

- Ao ligar a **seta esquerda**, pode aparecer:

```text
can0  0x210   [8]  00 01 00 00 00 00 00 00
```

- ID `0x210` parece controlar luzes do painel.
- O **segundo byte (`01`)** pode ser a seta esquerda

### Passo 2: Enviar comando para Ligar Seta Esquerda

```bash
cansend can0 0x210#0001000000000000
```

- `01` no segundo byte ativa a seta

### Passo 3: Desligar Seta

```bash
cansend can0 0x210#0000000000000000
```

- Todos os bytes em `00` desligam as luzes

---
## Exemplo 3: Ligar/Desligar o Carro (Start/Stop)

Alguns veículos permitem **ligar/desligar o motor** via CAN (em carros com botão de start/stop).

### Passo 1: Identificar o Comando de Ignition

- Ao pressionar o botão de **ignição**, pode aparecer:

```text
can0  0x101   [8]  01 00 00 00 00 00 00 00
```

- ID `0x101` pode ser o controle de ignição.
- `01` no primeiro byte = ligar motor.

### Passo 2: Enviar Comando para Ligar o Motor

```bash
cansend can0 0x101#0100000000000000
```

### Passo 3: Enviar Comando para Desligar o Motor

```bash
cansend can0 0x101#0000000000000000
```

---
# Ferramentas Relacionadas

- **Kayak:** Interface gráfica para análise CAN.
- **Wireshark (Plugin CAN):** Analisador de protocolos com suporte a CAN.
- **CANToolz:** Framework para pentesting em redes CAN.
- **SavvyCAN:** Ferramenta avançada para engenharia reversa CAN.

---
# Riscos e Considerações de Segurança

1. **Injeção de Mensagens Pode Ser Perigosa**
	- Se enviar comandos errados, pode causar:
		- Travamento de ECUs.
		- Ativação acidental de airbags.
		- Danos ao sistema elétrico.

2. **Veículos Modernos têm Proteções**
	- Algumas ECUs exigem **mensagens de autenticação (ex.: CAN+ ou Secure CAN).**

3. **Use Apenas em Ambiente Controlado**
	- Prefira **redes CAN simuladas** (`vcan0`) ou **veículos de teste**.

---
# Conclusão

O CanSniffer é uma ferramenta essencial para profissionais que trabalham com redes CAN, seja para diagnóstico, desenvolvimento ou segurança. Sua capacidade de filtrar e analisar mensagens em tempo real o torna indispensável em cenários que exigem monitoramento preciso e engenharia reversa.

>[!warning] Aviso Legal
>O uso de ferramentas como CanSniffer em veículos sem permissão pode violar leis locais. Sempre obtenha autorização antes de analisar sistemas embarcados.


