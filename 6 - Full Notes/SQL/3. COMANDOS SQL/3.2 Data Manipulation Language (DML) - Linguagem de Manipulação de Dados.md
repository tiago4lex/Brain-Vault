2025-09-23 19:06

Status: #developed #SQL 

Tags: [[4 - Indexes/SQL|SQL]] | [[DML]]

----
# Introdução

## O que é DML?

DML *(Data Manipulation Language)* é um subconjunto do SQL utilizado para manipular dados armazenados em um banco de dados. O DML engloba os comandos responsáveis por inserir, atualizar, excluir e consultar dados nas tabelas.

## Características Principais

- **Foco nos Dados:** Manipula o conteúdo das tabelas, não a estrutura.
- **Operações CRUD:** *Create, Read, Update, Delete*.
- **Transacional:** Pode ser confirmada ou revertida.
- **Não DDL:** Não altera esquema do banco.

## Comandos DML Principais

```sql
-- Os 4 comandos fundamentais do DML
SELECT -- Consultar dados
INSERT -- Inserir dados
UPDATE -- Atualizar dados
DELETE -- Excluir dados
```

---
# Comando `SELECT` - Consulta de Dados

## Sintaxe Básica

```sql
SELECT coluna1, coluna2, ...
FROM nome_tabela
[WHERE condição]
[LIMIT quantidade];
```

## Exemplos Práticos

```sql
-- Selecionar todas as colunas
SELECT * FROM clientes;

-- Selecionar colunas específicas
SELECT nome, email FROM clientes;

-- Com condição WHERE
SELECT * FROM produtos WHERE preco > 100;

-- Com ordenação
SELECT * FROM funcionarios ORDER BY salario DESC;

-- Com limite
SELECT * FROM pedidos LIMIT 10;
```

## `SELECT` com Funções de Agregação

```sql
-- Contar registros
SELECT COUNT(*) FROM clientes;

-- Soma de valores
SELECT SUM(valor) FROM vendas;

-- Média
SELECT AVG(salario) FROM funcionarios;

-- Máximo e Mínimo
SELECT MAX(preco), MIN(preco) FROM produtos;

-- Agrupamento
SELECT departamento, AVG(salario)
FROM funcionarios
GROUP BY departamento;
```

---
# Comando `INSERT` - Inserção de Dados

## Sintaxe Básica

```sql
INSERT INTO tabela (coluna1, coluna2, ...)
VALUES (valor1, valor2, ...);
```

## Formas de Inserção

```sql
-- Inserção com todas as colunas (na ordem da tabela)
INSERT INTO clientes
VALUES (1, 'João Silva', 'joao@email.com', '1990-05-15');

-- Inserção com colunas específicas
INSERT INTO clientes (nome, email)
VALUES ('Maria Santos', 'maria@email.com');

-- Inserção múltipla
INSERT INTO produtos (nome, preco, categoria)
VALUES 
    ('Notebook', 2500.00, 'Informática'),
    ('Mouse', 89.90, 'Informática'),
    ('Teclado', 150.00, 'Informática');

-- Inserção a partir de SELECT
INSERT INTO clientes_backup (id, nome, email)
SELECT id, nome, email FROM clientes 
WHERE data_cadastro < '2023-01-01';
```

## Considerações Importantes

- **Chaves Primárias:** Devem ser únicas
- **Valores Nulos:** Colunas ``NOT NULL`` devem ter valor
- **Tipos de Dados:** Devem ser compatíveis
- ***Constraints*:** Respeitar restrições da tabela

---
# Comando `UPDATE` - Atualização de Dados

## Sintaxe Básica

```sql
UPDATE tabela
SET coluna1 = valor1, coluna2 = valor2, ...
[WHERE condição];
```

## Exemplos Práticos

```sql
-- Atualizar um registro específico
UPDATE clientes 
SET email = 'novo_email@email.com'
WHERE id = 1;

-- Atualizar múltiplas colunas
UPDATE produtos 
SET preco = preco * 1.10, estoque = estoque - 1
WHERE categoria = 'Eletrônicos';

-- Atualizar com base em subconsulta
UPDATE funcionarios 
SET salario = salario * 1.05
WHERE departamento_id IN (
    SELECT id FROM departamentos WHERE nome = 'Vendas'
);

-- Atualização condicional com CASE
UPDATE produtos 
SET preco = CASE 
    WHEN categoria = 'Premium' THEN preco * 1.15
    WHEN categoria = 'Standard' THEN preco * 1.10
    ELSE preco * 1.05
END;
```

## Cuidados com `UPDATE`

```sql
-- ⚠️ PERIGO: Atualiza TODOS os registros se omitir WHERE
UPDATE clientes SET status = 'Inativo';  -- TODOS ficam inativos!

-- ✅ FORMA CORRETA
UPDATE clientes SET status = 'Inativo' 
WHERE ultima_compra < '2022-01-01';
```

---
# Comando `DELETE` - Exclusão de Dados

## Sintaxe Básica

```sql
DELETE FROM tabela
[WHERE condição];
```

## Exemplo Práticos

```sql
-- Excluir registro específico
DELETE FROM clientes WHERE id = 10;

-- Excluir com condição complexa
DELETE FROM pedidos 
WHERE data_pedido < '2020-01-01' 
AND status = 'Cancelado';

-- Excluir usando subconsulta
DELETE FROM produtos 
WHERE categoria_id IN (
    SELECT id FROM categorias WHERE nome = 'Descontinuado'
);

-- Excluir todos os registros (cuidado!)
DELETE FROM log_acessos;  -- Limpa toda a tabela
```

## `DELETE` vs `TRUNCATE`

```sql
-- DELETE: Exclui registro por registro, pode ser revertido
DELETE FROM temp_table;  -- Pode usar ROLLBACK

-- TRUNCATE: Exclui todos os dados de uma vez, mais rápido
TRUNCATE TABLE temp_table;  -- Não pode ser revertido
```

---
# Comando `MERGE`/`UPSERT` - Inserção ou Atualização

## Sintaxe (varia por SGBD)

```sql
-- SQL Standard (MERGE)
MERGE INTO tabela_destino USING tabela_origem
ON (condição_de_casamento)
WHEN MATCHED THEN
    UPDATE SET coluna1 = valor1, ...
WHEN NOT MATCHED THEN
    INSERT (colunas) VALUES (valores);

-- PostgreSQL (INSERT ... ON CONFLICT)
INSERT INTO tabela (colunas) VALUES (valores)
ON CONFLICT (coluna_chave) 
DO UPDATE SET coluna1 = EXCLUDED.coluna1;

-- MySQL (INSERT ... ON DUPLICATE KEY UPDATE)
INSERT INTO tabela (colunas) VALUES (valores)
ON DUPLICATE KEY UPDATE coluna1 = VALUES(coluna1);
```

## Exemplo Prático

```sql
-- Atualizar estoque ou inserir novo produto
MERGE INTO estoque USING (
    SELECT 1 as produto_id, 50 as quantidade
) nova_entrada
ON (estoque.produto_id = nova_entrada.produto_id)
WHEN MATCHED THEN
    UPDATE SET quantidade = estoque.quantidade + nova_entrada.quantidade
WHEN NOT MATCHED THEN
    INSERT (produto_id, quantidade) 
    VALUES (nova_entrada.produto_id, nova_entrada.quantidade);
```