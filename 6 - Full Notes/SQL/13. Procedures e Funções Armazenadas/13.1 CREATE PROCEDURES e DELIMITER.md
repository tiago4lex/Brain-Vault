
2025-10-21 20:01

Status: #developed #SQL 

Tags: [[4 - Indexes/SQL|SQL]]

----
# Introdução

Em sistemas de banco de dados com MySQL, uma **procedure** (ou **stored procedure**) é um **bloco de código SQL armazenado no servidor** que pode ser **executado sob demanda**.

Elas são usadas para **automatizar tarefas repetitivas, executar cálculos, gerar relatórios, manipular dados  e encapsular lógica de negócio diretamente no banco de dados**.

---
# O que é uma *Stored Procedure*?

Uma ***stored procedure*** é um conjunto de instruções SQL armazenadas no servidor, com um nome, que pode receber **parâmetros de entrada ou saída**.

Ela pode ser chamada com o comando `CALL nome_da_procedure(parâmetros)`.

### Vantagens de usar procedures:

- Evitam repetição de código SQL em várias partes da aplicação.
- Aumentam a **performance**, pois ficam **compiladas** no servidor.
- Reduzem **tráfego entre aplicação e servidor**, processando dados diretamente no banco.
- Permitem **controle e segurança**, pois usuários podem ter acesso à procedure sem precisar acessar diretamente as tabelas.

---
# Sintaxe básica do `CREATE PROCEDURE`

```sql
DELIMITER $

CREATE PROCEDURE nome_procedure ([parâmetros])
BEGIN
    -- bloco de instruções SQL
END $
DELIMITER ;
```

**Explicação:**

- `DELIMITER` → muda o delimitador de comandos temporariamente (por padrão é `;`).
- `CREATE PROCEDURE` → cria a procedure.
- `IN` / `OUT` / `INOUT` → definem o tipo do parâmetro:
	- `IN`: parâmetro de entrada.
	- `OUT`: parâmetro de saída.
	- `INOUT`: parâmetro de entrada e saída.
- `BEGIN ...  END` → bloco de código com múltiplos comandos SQL.
- `DECLARE` → usado para declarar variáveis locais.
- `SELECT ... INTO` → atribui o resultado de uma consulta a variáveis.
- `CALL nome_da_procedure(...)` → executa a procedure.
- `DROP PROCEDURE nome` → exclui a procedure.

---
# O comando `DELIMITER`

Por padrão, o MySQL usa `;` como delimitador de comandos.
Mas dentro de uma procedure **há muitos comandos SQL**, e cada um deles **também termina com `;`**.

Se não alterarmos o delimitador, o MySQL interpretará o primeiro `;` como **fim da procedure** gerando erro.

Por isso usamos:

```sql
DELIMITER $
-- corpo da procedure
END $
DELIMITER ;
```

Assim, o MySQL entende que o **fim da procedure** ocorre **somente** quando encontra o `$`.

---
# Exemplos explicados

## Exemplo 1 - Procedure `soma`

```sql
DELIMITER $
CREATE PROCEDURE soma(IN op1 INT, IN op2 INT)
BEGIN
    DECLARE resultado INT;
    SET resultado = op1 + op2;
    SELECT resultado AS valor;
END $
DELIMITER ;
CALL soma(5, 7);
DROP PROCEDURE soma;
```

**Explicação passo a passo:**

1. **`DELIMITER $`** → muda o delimitador para `$`.
2. **`CREATE PROCEDURE soma(IN op1 INT, IN op2 INT)`**  
    Cria a procedure chamada **soma**, com **dois parâmetros de entrada** (`op1` e `op2`).
3. **`DECLARE resultado INT;`**  
    Cria uma variável local chamada `resultado`.
4. **`SET resultado = op1 + op2;`**  
    Soma os dois parâmetros e armazena o resultado.
5. **`SELECT resultado AS valor;`**  
    Exibe o valor da soma com o nome da coluna `valor`.
6. **`END $` / `DELIMITER ;`** → encerra a definição da procedure.
7. **`CALL soma(5, 7);`** → executa a procedure com os valores 5 e 7.
8. **`DROP PROCEDURE soma;`** → apaga a procedure do banco.

**Saída esperada:**

|valor|
|---|
|12|

## Exemplo 2 - Procedure `inserir_padrao`

```sql
DELIMITER $
CREATE PROCEDURE inserir_padrao(IN linguagem VARCHAR(20))
BEGIN
    INSERT INTO language VALUES (DEFAULT, linguagem, "2001-01-01 00:00:01");
END $
DELIMITER ;
CALL inserir_padrao("Português");
SELECT * FROM language;
DROP PROCEDURE inserir_padrao;
```

**Explicação passo a passo:**

1. **`CREATE PROCEDURE inserir_padrao(IN linguagem VARCHAR(20))`**  
    Cria uma procedure que recebe uma **string de entrada** chamada `linguagem`.

2. **`INSERT INTO language VALUES (DEFAULT, linguagem, "2001-01-01 00:00:01");`**  
    Insere um novo registro na tabela `language`.
    - `DEFAULT`: insere o valor padrão do campo `language_id` (geralmente `AUTO_INCREMENT`).
    - `linguagem`: valor passado como parâmetro.        
    - `"2001-01-01 00:00:01"`: data e hora fixas.

3. **`CALL inserir_padrao("Português");`**  
    Executa a procedure e insere o idioma “Português”.
    
4. **`SELECT * FROM language;`**  
    Mostra todos os registros da tabela.

5. **`DROP PROCEDURE inserir_padrao;`**  
    Exclui a procedure.

**Saída esperada:**

| language_id | name      | last_update         |
| ----------- | --------- | ------------------- |
| 1           | English   | 2006-02-15 05:02:19 |
| 2           | Português | 2001-01-01 00:00:01 |

## Exemplo 3 - Procedure `media_limiar`

```sql
DELIMITER $
CREATE PROCEDURE media_limiar(IN corte INT)
BEGIN
    DECLARE media_menor FLOAT;
    DECLARE media_maior FLOAT;
    
    SELECT AVG(amount) INTO media_menor FROM payment WHERE payment_id < corte;
    SELECT AVG(amount) INTO media_maior FROM payment WHERE payment_id > corte;
    
    SELECT media_menor AS menor, media_maior AS maior;
END $
DELIMITER ;
CALL media_limiar(401);
DROP PROCEDURE media_limiar;
```

**Explicação passo a passo:**

1. **`CREATE PROCEDURE media_limiar(IN corte INT)`**  
    Cria uma procedure com um parâmetro de entrada inteiro.
2. **`DECLARE media_menor FLOAT;`**  
    Cria variável para armazenar a média dos valores **menores que o corte**.
3. **`DECLARE media_maior FLOAT;`**  
    Cria variável para armazenar a média dos valores **maiores que o corte**.
4. **`SELECT AVG(amount) INTO media_menor FROM payment WHERE payment_id < corte;`**
    Calcula a média dos pagamentos **antes** do ID informado.
5. **`SELECT AVG(amount) INTO media_maior FROM payment WHERE payment_id > corte;`**
    Calcula a média dos pagamentos **após** o ID informado.
6. **`SELECT media_menor AS menor, media_maior AS maior;`**  
    Exibe ambas as médias em uma tabela.
7. **`CALL media_limiar(401);`**  
    Executa a procedure com o parâmetro `401`.
8. **`DROP PROCEDURE media_limiar;`**  
    Exclui a procedure após o uso.

**Saída esperada:**

|menor|maior|
|---|---|
|3.24|4.18|

---
# Conclusão


As **procedures no MySQL** são fundamentais para:

- Criar **rotinas reutilizáveis**.    
- Reduzir o uso de código repetido.
- **Centralizar regras de negócio** no banco de dados.
- **Melhorar a performance** e a manutenção do sistema.

O uso de `DELIMITER` é essencial para definir corretamente o **início e o fim da procedure**.  
Sem ele, o MySQL não consegue distinguir onde termina o bloco `BEGIN...END`.

---
# Resumo

|Comando|Função|
|---|---|
|`CREATE PROCEDURE`|Cria uma procedure|
|`CALL`|Executa a procedure|
|`DROP PROCEDURE`|Remove a procedure|
|`IN`|Parâmetro de entrada|
|`OUT`|Parâmetro de saída|
|`DECLARE`|Declara variáveis locais|
|`SET`|Atribui valor a variáveis|
|`SELECT ... INTO`|Armazena resultados em variáveis|
|`DELIMITER`|Altera o delimitador temporário|