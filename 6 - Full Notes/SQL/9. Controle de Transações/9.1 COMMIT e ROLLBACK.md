2025-10-21 20:33

Status: #developed #SQL 

Tags: [[4 - Indexes/SQL|SQL]]

----
# Introdução

Em sistemas de banco de dados, especialmente em aplicações que envolvem **transações** é fundamental garantir que os dados permaneçam consistentes e íntegros, mesmo diante de falhas ou erro.

No MySQL, os comandos `COMMIT` e `ROLLBACK` são usados justamente para **controlar transações**, permitindo que você **confirme ou desfaça** um conjunto de operações realizadas.

---
# O que é uma transação?

Uma **transação é um conjunto de operações SQL** que devem ser executadas como **uma unidade lógica**.

Ou seja:
- Ou todas as operações são concluídas com sucesso (COMMIT).
- Ou nenhuma delas é aplicada (ROLLBACK).

**Exemplo de conceito de transação:**
Imagine uma transferência bancária entre duas contas:
1. Você **debita** R$100,00 da Conta A.
2. Você **credita** R$100,00 da Conta B.

Essas duas operações devem ser **atômicas** - se uma falhar, a outra também deve ser desfeita.

---
# Propriedades ACID das transações

Toda transação deve seguir as propriedades **ACID**, que garantem integridade e segurança dos dados:

|Propriedade|Descrição|
|---|---|
|**Atomicidade (A)**|Todas as operações são tratadas como uma unidade indivisível.|
|**Consistência (C)**|A transação leva o banco de um estado consistente a outro.|
|**Isolamento (I)**|Cada transação ocorre de forma independente das demais.|
|**Durabilidade (D)**|Após o `COMMIT`, as mudanças persistem mesmo que o sistema falhe.|

---
# Sintaxe básica

```sql
START TRANSACTION;
-- ou BEGIN;

-- Suas operações SQL aqui
-- Exemplo: INSERT, UPDATE, DELETE

COMMIT;
-- ou
ROLLBACK;
```

**Explicação:**

- `START TRANSACTION` ou `BEGIN` → inicia uma nova transação.
- `COMMIT` → confirma todas as operações executadas desde o início da transação.
- `ROLLBACK` → desfez todas as operações executadas desde o início da transação.

>[!warning] Importante:
>Nem todas as tabelas do MySQL suportam transações.
>É necessário que as tabelas sejam do tipo **InnoDB** (e não MyISAM).

---
# Exemplo 1- COMMIT (confirmando as alterações)

```sql
START TRANSACTION;

INSERT INTO contas (id, titular, saldo) VALUES (1, 'Maria', 500);
INSERT INTO contas (id, titular, saldo) VALUES (2, 'Alexandre', 800);

COMMIT;
```

**Explicação:**

1.  `START TRANSACTIOn` inicia o controle transacional.
2. São feitos **dois inserts** na tabela `contas`.
3. `COMMIT` confirma as duas operações e grava definitivamente os dados no banco.

**Resultado:**

Ambas as contas são inseridas no banco de dados.
Se houver falhas após o `COMMIT`, os dados já estarão salvos.

---
# Exemplo 2 - ROLLBACK (cancelando as alterações)

```sql
START TRANSACTION;

UPDATE contas SET saldo = saldo - 100 WHERE id = 1;
UPDATE contas SET saldo = saldo + 100 WHERE id = 2;

-- Algo deu errado! Vamos desfazer
ROLLBACK;
```

**Explicação:**

1. A transação inicia.
2. O saldo da conta 1 é reduzido em R$100, e o da conta 2 é aumentado.
3. Suponha que o sistema detecte erro (ex: conexão perdida ou valor incorreto).
4. **`ROLLBACK`** cancela **ambas** as operações.

**Resultado:**  
Nenhuma alteração é gravada no banco; os saldos permanecem originais.

---
# Exemplo 3 - Comparando COMMIT e ROLLBACK

|Etapa|Comando SQL|Ação|Resultado|
|---|---|---|---|
|1|`START TRANSACTION;`|Inicia a transação|Nenhum dado alterado ainda|
|2|`INSERT INTO clientes VALUES (...);`|Insere dado|Alteração temporária|
|3|`UPDATE produtos SET estoque = estoque - 1;`|Atualiza estoque|Alteração temporária|
|4|`COMMIT;`|Confirma|Dados salvos permanentemente|
|4 (alternativo)|`ROLLBACK;`|Cancela|Nenhuma alteração aplicada|

---
# Exemplo 4 - Caso prático: transferência bancária

Imagina a tabela `contas`:

| id  | titular | saldo   |
| --- | ------- | ------- |
| 1   | Maria   | 1000.00 |
| 2   | Lucas   | 500.00  |

### Script SQL com transação

```sql
START TRANSACTION;

UPDATE contas SET saldo = saldo - 200 WHERE id = 1;
UPDATE contas SET saldo = saldo + 200 WHERE id = 2;

COMMIT;
```

**Resultado:**

| id  | titular | saldo  |
| --- | ------- | ------ |
| 1   | Maria   | 800.00 |
| 2   | Lucas   | 700.00 |

Agora imagine que um erro ocorre após a primeira operação:

```sql
START TRANSACTION;

UPDATE contas SET saldo = saldo - 200 WHERE id = 1;
-- ERRO: a conta de destino não existe!
ROLLBACK;
```

**Resultado após o ROLLBACK**:

| id  | titular | saldo   |
| --- | ------- | ------- |
| 1   | Maria   | 1000.00 |
| 2   | Lucas   | 500.00  |

Nenhuma alteração foi aplicada - segurança total dos dados.

---
# Exemplo 5 - Transação com múltiplas tabelas

```sql
START TRANSACTION;

INSERT INTO pedidos (id_cliente, data_pedido, total)
VALUES (1, NOW(), 200.00);

UPDATE estoque SET quantidade = quantidade - 1 WHERE id_produto = 10;

COMMIT;
```

Caso o produto não exista no estoque:

```sql
START TRANSACTION;

INSERT INTO pedidos (id_cliente, data_pedido, total)
VALUES (1, NOW(), 200.00);

UPDATE estoque SET quantidade = quantidade - 1 WHERE id_produto = 9999;

ROLLBACK;
```

**Explicação:**

- Se o produto for válido, ambas as operações são confirmadas com `COMMIT`.
- Se o produto não existir, a transação é **desfeita**, mantendo a integridade entre pedidos e estoque.

---
# Exemplo 6 - Verificando transações automáticas

Por padrão, o MySQL pode estar com **autocommit ativado**.
Isso significa que **cada instrução é confirmada automaticamente** sem precisar de `COMMIT`.

Para verificar:

```sql
SELECT @autocommit;
```

- **Retorno 1:** autocommit ativado (cada operação é confirmada automaticamente).  
- **Retorno 0:** autocommit desativado (as operações esperam `COMMIT`).

É possível **desativar o autocommit** temporariamente:

```sql
SET autocommit = 0;
START TRANSACTION;
-- operações
COMMIT;
```

E reativar depois:

```sql
SET autocommit = 1;
```

---
# Dicas e Boas Práticas

✅ Sempre inicie suas transações com `START TRANSACTION` ou `BEGIN`.  
✅ Finalize com `COMMIT` ou `ROLLBACK` — **nunca deixe a transação aberta**.  
✅ Use `ROLLBACK` para evitar inconsistências em caso de erro.  
✅ Trabalhe apenas com tabelas do tipo **InnoDB**.  
✅ Combine com **tratamento de erros** em procedures para segurança adicional.

---
# Resumo Geral

|Comando|Função|Descrição|
|---|---|---|
|`START TRANSACTION`|Inicia a transação|Prepara o ambiente transacional|
|`COMMIT`|Confirma|Aplica permanentemente as operações|
|`ROLLBACK`|Cancela|Desfaz todas as operações pendentes|
|`SET autocommit = 0`|Desativa commits automáticos|Controle manual de transações|
|`SET autocommit = 1`|Reativa commits automáticos|Volta ao comportamento padrão|

---
# Conclusão

Os comandos **`COMMIT`** e **`ROLLBACK`** são ferramentas essenciais no MySQL para garantir **consistência, segurança e confiabilidade** dos dados.  
Eles são amplamente usados em sistemas de controle financeiro, vendas, estoques e qualquer cenário onde múltiplas operações dependam umas das outras.

Saber **quando confirmar (`COMMIT`) e quando reverter (`ROLLBACK`)** é o que diferencia um sistema robusto de um sistema vulnerável a falhas.